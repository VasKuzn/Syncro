<!DOCTYPE html>
<html>

<head>
    <title>Syncro Chat Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            display: flex;
            gap: 20px;
        }

        .panel {
            flex: 1;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            background: #f9f9f9;
        }

        h1,
        h2 {
            margin-top: 0;
            color: #333;
        }

        input,
        button {
            padding: 10px;
            margin: 8px 0;
            width: 100%;
            box-sizing: border-box;
            border-radius: 4px;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background: #45a049;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover {
            background: #d32f2f;
        }

        button.secondary {
            background: #2196F3;
        }

        button.secondary:hover {
            background: #0b7dda;
        }

        .messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
            background: white;
            border-radius: 4px;
        }

        .message {
            margin-bottom: 12px;
            padding: 10px;
            background: #f1f1f1;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }

        .message.pinned {
            border-left: 4px solid #FFC107;
            background: #fff8e1;
        }

        .message.edited:after {
            content: " (edited)";
            color: #888;
            font-size: 0.9em;
        }

        .status {
            color: #666;
            font-style: italic;
            margin-bottom: 10px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .sender-name {
            font-weight: bold;
            color: #333;
        }

        .message-time {
            color: #666;
            font-size: 0.8em;
        }

        .message-actions {
            margin-top: 5px;
        }

        .online-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .online {
            background: #4CAF50;
        }

        .offline {
            background: #f44336;
        }

        .controls {
            margin-top: 15px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <h1>Syncro Chat Hub Tester</h1>

    <div class="container">
        <div class="panel" id="user1Panel">
            <h2>User 1 (Alex)</h2>
            <div id="user1Status" class="status">
                <span class="online-status offline"></span>
                <span>Disconnected</span>
            </div>

            <div id="user1Messages" class="messages"></div>

            <div class="controls">
                <input type="text" id="user1Message" placeholder="Type your message">
                <button onclick="sendMessageUser1()">Send Message</button>
                <button class="secondary" onclick="loadMoreMessages('user1')">Load More Messages</button>
            </div>
        </div>

        <div class="panel" id="user2Panel">
            <h2>User 2 (Sam)</h2>
            <div id="user2Status" class="status">
                <span class="online-status offline"></span>
                <span>Disconnected</span>
            </div>

            <div id="user2Messages" class="messages"></div>

            <div class="controls">
                <input type="text" id="user2Message" placeholder="Type your message">
                <button onclick="sendMessageUser2()">Send Message</button>
                <button class="secondary" onclick="loadMoreMessages('user2')">Load More Messages</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        // Фиксированные ID для тестирования
        const USER1_ID = '330f8dfa-57cc-459e-b469-bb0572ce71fb';
        const USER2_ID = 'c2f9335b-33a7-4941-90e0-8b3a8569d5cc';
        const CONFERENCE_ID = '3fa85f64-5717-4562-b3fc-2c963f66afb8';

        // Замените на ваш URL хаба
        const HUB_URL = 'http://localhost:5000/chatHub';

        let user1Connection = null;
        let user2Connection = null;
        let loadedMessagesCount = 0;

        // Автоматическое подключение при загрузке страницы
        window.onload = async function () {
            await connectUser1();
            await connectUser2();
        };

        // Функции для User 1
        async function connectUser1() {
            user1Connection = new signalR.HubConnectionBuilder()
                .withUrl(`${HUB_URL}?userId=${USER1_ID}`)
                .configureLogging(signalR.LogLevel.Information)
                .build();

            setupConnectionHandlers(user1Connection, 'user1');

            try {
                await user1Connection.start();
                updateStatus('user1', true);
                console.log('User 1 connected');

                // Автоматически присоединяемся к конференции
                await joinConference('user1');
            } catch (err) {
                console.error('User 1 connection error:', err);
            }
        }

        // Функции для User 2
        async function connectUser2() {
            user2Connection = new signalR.HubConnectionBuilder()
                .withUrl(`${HUB_URL}?userId=${USER2_ID}`)
                .configureLogging(signalR.LogLevel.Information)
                .build();

            setupConnectionHandlers(user2Connection, 'user2');

            try {
                await user2Connection.start();
                updateStatus('user2', true);
                console.log('User 2 connected');

                // Автоматически присоединяемся к конференции
                await joinConference('user2');
            } catch (err) {
                console.error('User 2 connection error:', err);
            }
        }

        async function joinConference(userPrefix) {
            const connection = userPrefix === 'user1' ? user1Connection : user2Connection;

            try {
                await connection.invoke('JoinPersonalConference', CONFERENCE_ID,
                    userPrefix === 'user1' ? USER1_ID : USER2_ID);
                console.log(`${userPrefix} joined conference`);
            } catch (err) {
                console.error(`${userPrefix} join error:`, err);
            }
        }

        async function sendMessageUser1() {
            await sendMessage('user1');
        }

        async function sendMessageUser2() {
            await sendMessage('user2');
        }

        async function sendMessage(userPrefix) {
            const messageInput = document.getElementById(`${userPrefix}Message`);
            const message = messageInput.value.trim();

            if (!message) return;

            const connection = userPrefix === 'user1' ? user1Connection : user2Connection;

            try {
                await connection.invoke('SendPersonalMessageAsync', CONFERENCE_ID,
                    userPrefix === 'user1' ? USER1_ID : USER2_ID, message);
                messageInput.value = '';
            } catch (err) {
                console.error(`${userPrefix} send error:`, err);
            }
        }

        async function loadMoreMessages(userPrefix) {
            const connection = userPrefix === 'user1' ? user1Connection : user2Connection;

            try {
                await connection.invoke('LoadMoreMessages', CONFERENCE_ID, loadedMessagesCount);
                loadedMessagesCount += 50;
            } catch (err) {
                console.error(`${userPrefix} load more error:`, err);
            }
        }

        function updateStatus(userPrefix, isConnected) {
            const statusElement = document.getElementById(`${userPrefix}Status`);
            const statusDot = statusElement.querySelector('.online-status');

            if (isConnected) {
                statusDot.classList.remove('offline');
                statusDot.classList.add('online');
                statusElement.querySelector('span:last-child').textContent = 'Connected';
            } else {
                statusDot.classList.remove('online');
                statusDot.classList.add('offline');
                statusElement.querySelector('span:last-child').textContent = 'Disconnected';
            }
        }

        function setupConnectionHandlers(connection, userPrefix) {
            connection.on('ReceiveMessage', (message) => {
                addMessageToUI(userPrefix, message);
            });

            connection.on('MessageEdited', (data) => {
                updateMessageInUI(data.MessageId, data.NewContent);
            });

            connection.on('MessageDeleted', (messageId) => {
                deleteMessageFromUI(messageId);
            });

            connection.on('MessagePinToggled', (data) => {
                toggleMessagePinInUI(data.MessageId, data.IsPinned);
            });

            connection.on('ReceiveInitialData', (data) => {
                document.getElementById(`${userPrefix}Messages`).innerHTML = '';
                loadedMessagesCount = data.Messages.length;

                data.Messages.forEach(msg => {
                    addMessageToUI(userPrefix, {
                        MessageId: msg.Id,
                        SenderId: msg.accountId,
                        SenderName: msg.accountId === USER1_ID ? 'Alex' : 'Sam',
                        Content: msg.messageContent,
                        Timestamp: msg.messageDateSent,
                        IsPinned: msg.isPinned
                    });
                });

                // Обновляем статус онлайн
                const otherUserStatus = document.getElementById(
                    userPrefix === 'user1' ? 'user2Status' : 'user1Status'
                );
                const statusDot = otherUserStatus.querySelector('.online-status');

                if (data.IsOtherOnline) {
                    statusDot.classList.remove('offline');
                    statusDot.classList.add('online');
                } else {
                    statusDot.classList.remove('online');
                    statusDot.classList.add('offline');
                }
            });

            connection.on('ReceiveMoreMessages', (messages) => {
                messages.reverse().forEach(msg => {
                    addMessageToUI(userPrefix, {
                        MessageId: msg.Id,
                        SenderId: msg.accountId,
                        SenderName: msg.accountId === USER1_ID ? 'Alex' : 'Sam',
                        Content: msg.messageContent,
                        Timestamp: msg.messageDateSent,
                        IsPinned: msg.isPinned
                    }, true); // Добавляем в начало
                });
            });

            connection.onclose(() => {
                updateStatus(userPrefix, false);
            });
        }

        function addMessageToUI(userPrefix, message, prepend = false) {
            const messagesDiv = document.getElementById(`${userPrefix}Messages`);
            const messageElement = document.createElement('div');

            messageElement.className = 'message';
            if (message.IsPinned) messageElement.classList.add('pinned');
            messageElement.dataset.messageId = message.MessageId;

            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="sender-name">${message.SenderName}</span>
                    <span class="message-time">${new Date(message.Timestamp).toLocaleTimeString()}</span>
                </div>
                <div class="message-content">${message.Content}</div>
                <div class="message-actions">
                    <button class="secondary" onclick="editMessage('${message.MessageId}')">Edit</button>
                    <button class="danger" onclick="deleteMessage('${message.MessageId}')">Delete</button>
                    <button onclick="togglePinMessage('${message.MessageId}')">
                        ${message.IsPinned ? 'Unpin' : 'Pin'}
                    </button>
                </div>
            `;

            if (prepend) {
                messagesDiv.insertBefore(messageElement, messagesDiv.firstChild);
            } else {
                messagesDiv.appendChild(messageElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        function updateMessageInUI(messageId, newContent) {
            document.querySelectorAll(`.message[data-message-id="${messageId}"]`).forEach(el => {
                const contentElement = el.querySelector('.message-content');
                if (contentElement) {
                    contentElement.textContent = newContent;
                    el.classList.add('edited');
                }
            });
        }

        function deleteMessageFromUI(messageId) {
            document.querySelectorAll(`.message[data-message-id="${messageId}"]`).forEach(el => {
                el.remove();
            });
        }

        function toggleMessagePinInUI(messageId, isPinned) {
            document.querySelectorAll(`.message[data-message-id="${messageId}"]`).forEach(el => {
                if (isPinned) {
                    el.classList.add('pinned');
                    el.querySelector('.message-actions button:nth-child(3)').textContent = 'Unpin';
                } else {
                    el.classList.remove('pinned');
                    el.querySelector('.message-actions button:nth-child(3)').textContent = 'Pin';
                }
            });
        }

        // Глобальные функции для действий с сообщениями
        window.editMessage = function (messageId) {
            const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
            const currentContent = messageElement.querySelector('.message-content').textContent;
            const newContent = prompt("Edit message:", currentContent);

            if (newContent && newContent !== currentContent) {
                user1Connection.invoke('EditMessage', messageId, newContent)
                    .catch(err => console.error('Edit error:', err));
            }
        };

        window.deleteMessage = function (messageId) {
            if (confirm("Are you sure you want to delete this message?")) {
                user1Connection.invoke('DeleteMessage', messageId)
                    .catch(err => console.error('Delete error:', err));
            }
        };

        window.togglePinMessage = function (messageId) {
            user1Connection.invoke('TogglePinMessage', messageId)
                .catch(err => console.error('Pin toggle error:', err));
        };

        // Обработчики нажатия Enter для отправки сообщений
        document.getElementById('user1Message').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessageUser1();
        });

        document.getElementById('user2Message').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessageUser2();
        });
    </script>
</body>

</html>